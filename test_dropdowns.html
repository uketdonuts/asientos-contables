<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba Dropdowns - Asientos Contables</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold mb-6">Prueba de Dropdowns</h1>

        <!-- Dropdown de Perfil -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Perfil Contable</label>
            <select id="id_perfil" class="block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                <option value="">Seleccione un perfil</option>
                <option value="1">Compra Activos</option>
                <option value="501bb865d4a92532cfebb65ee059e4889363eeb28a22ca6fb82165bb17432724">asdqwe</option>
            </select>
        </div>

        <!-- Dropdown de Cuenta -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Cuenta</label>
            <select id="cuenta_select" class="block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" disabled>
                <option value="">Seleccione perfil primero</option>
            </select>
        </div>

        <!-- Área de logs -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Logs de JavaScript</label>
            <textarea id="logs" rows="10" class="block w-full px-3 py-2 border border-gray-300 rounded-lg text-sm font-mono" readonly></textarea>
        </div>

        <!-- Botón de limpiar logs -->
        <button id="clearLogs" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Limpiar Logs</button>
    </div>

    <script>
        const perfilSelect = document.getElementById('id_perfil');
        const cuentaSelect = document.getElementById('cuenta_select');
        const logsTextarea = document.getElementById('logs');
        const clearLogsBtn = document.getElementById('clearLogs');

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logsTextarea.value += `[${timestamp}] ${message}\n`;
            logsTextarea.scrollTop = logsTextarea.scrollHeight;
            console.log(message);
        }

        function clearLogs() {
            logsTextarea.value = '';
        }

        clearLogsBtn.addEventListener('click', clearLogs);

        // Estado inicial
        log('Página cargada - Estado inicial:');
        log('- Perfil select: ' + (perfilSelect ? 'encontrado' : 'no encontrado'));
        log('- Cuenta select: ' + (cuentaSelect ? 'encontrado' : 'no encontrado'));
        log('- Cuenta select disabled: ' + cuentaSelect.disabled);
        log('- Cuenta select options: ' + cuentaSelect.options.length);

        // Event listener para cambio de perfil
        perfilSelect.addEventListener('change', function() {
            const perfilId = this.value;
            log('Perfil seleccionado: ' + perfilId);

            if (perfilId) {
                log('Intentando cargar cuentas para perfil: ' + perfilId);

                // Simular la llamada a la API (usando datos de prueba)
                fetch(`http://localhost:8002/asientos/api/perfil/${perfilId}/cuentas/`, {
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    log('Response status: ' + response.status);
                    if (response.status === 200) {
                        return response.json();
                    } else if (response.status === 302) {
                        log('Redirección detectada - probablemente necesita login');
                        throw new Error('Authentication required');
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                })
                .then(data => {
                    log('Datos recibidos: ' + JSON.stringify(data, null, 2));

                    if (data.success) {
                        cuentaSelect.innerHTML = '<option value="">Seleccione una cuenta</option>';

                        data.cuentas.forEach(cuenta => {
                            const option = document.createElement('option');
                            option.value = cuenta.id;
                            option.textContent = `${cuenta.codigo} - ${cuenta.descripcion}`;
                            cuentaSelect.appendChild(option);
                        });

                        cuentaSelect.disabled = false;
                        log('Cuenta select habilitado con ' + data.cuentas.length + ' opciones');
                    } else {
                        log('Error en respuesta: ' + (data.error || 'Error desconocido'));
                        cuentaSelect.disabled = true;
                        cuentaSelect.innerHTML = '<option value="">Error cargando cuentas</option>';
                    }
                })
                .catch(error => {
                    log('Error: ' + error.message);
                    cuentaSelect.disabled = true;
                    cuentaSelect.innerHTML = '<option value="">Error de conexión</option>';
                });
            } else {
                // Reset cuando no hay perfil seleccionado
                cuentaSelect.disabled = true;
                cuentaSelect.innerHTML = '<option value="">Seleccione perfil primero</option>';
                log('Cuenta select reseteado');
            }
        });

        log('Event listeners configurados correctamente');
    </script>
</body>
</html>