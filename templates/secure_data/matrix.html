{% extends "base.html" %}
{% load static %}
{% load secure_filters %}

{% block title %}Matriz de Datos Seguros{% endblock %}

{% block extra_css %}
<style>
    .matrix-container {
        margin: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .matrix-header {
        background: {% if is_real_data %}linear-gradient(135deg, #dc3545 0%, #c82333 100%){% else %}linear-gradient(135deg, #28a745 0%, #1e7e34 100%){% endif %};
        color: white;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .matrix-title {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .data-type-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: bold;
    }
    
    .matrix-table-container {
        overflow: auto;
        max-height: 70vh;
        background: #f8f9fa;
        padding: 20px;
    }
    
    .matrix-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 2px;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .matrix-table th {
        background: {% if is_real_data %}#dc3545{% else %}#28a745{% endif %};
        color: white;
        padding: 12px 8px;
        text-align: center;
        font-weight: 600;
        font-size: 14px;
        min-width: 100px;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .matrix-table th.row-header {
        background: {% if is_real_data %}#c82333{% else %}#1e7e34{% endif %};
        position: sticky;
        left: 0;
        z-index: 11;
    }
    
    .matrix-table td {
        background: white;
        border: 1px solid #e9ecef;
        position: relative;
    }
    
    .matrix-table td.row-header {
        background: {% if is_real_data %}#f8d7da{% else %}#d4edda{% endif %};
        font-weight: bold;
        text-align: center;
        position: sticky;
        left: 0;
        z-index: 9;
        color: {% if is_real_data %}#721c24{% else %}#155724{% endif %};
    }
    
    .cell-input {
        width: 100%;
        border: none;
        background: transparent;
        padding: 10px 8px;
        font-size: 14px;
        min-height: 40px;
        resize: none;
        font-family: 'Courier New', monospace;
    }
    
    .cell-input:focus {
        background: {% if is_real_data %}#fff5f5{% else %}#f8fff8{% endif %};
        outline: 2px solid {% if is_real_data %}#dc3545{% else %}#28a745{% endif %};
        outline-offset: -2px;
    }
    
    .cell-input.has-content {
        background: {% if is_real_data %}#ffe6e6{% else %}#e6ffe6{% endif %};
        font-weight: 500;
    }
    
    .save-indicator {
        position: absolute;
        top: 2px;
        right: 2px;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #28a745;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .save-indicator.saving {
        background: #ffc107;
        opacity: 1;
    }
    
    .save-indicator.saved {
        background: #28a745;
        opacity: 1;
    }
    
    .save-indicator.error {
        background: #dc3545;
        opacity: 1;
    }
    
    .logout-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 10px 18px;
        border-radius: 25px;
        text-decoration: none;
        transition: all 0.3s ease;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .logout-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        color: white;
        text-decoration: none;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .emergency-exit-btn {
        background: {% if is_real_data %}#dc3545{% else %}#ffc107{% endif %};
        color: {% if is_real_data %}white{% else %}#212529{% endif %};
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
        {% if is_real_data %}
        animation: pulse-red 2s infinite;
        {% endif %}
    }
    
    .emergency-exit-btn:hover {
        background: {% if is_real_data %}#c82333{% else %}#e0a800{% endif %};
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.4);
    }
    
    {% if is_real_data %}
    @keyframes pulse-red {
        0%, 100% { box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3); }
        50% { box-shadow: 0 4px 12px rgba(220, 53, 69, 0.6); }
    }
    {% endif %}
    
    .status-bar {
        background: #f8f9fa;
        padding: 10px 20px;
        border-top: 1px solid #dee2e6;
        font-size: 12px;
        color: #6c757d;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .encryption-badge {
        background: #17a2b8;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
    }
    
    .save-all-btn {
        background: {% if is_real_data %}#dc3545{% else %}#28a745{% endif %};
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .save-all-btn:hover {
        background: {% if is_real_data %}#c82333{% else %}#1e7e34{% endif %};
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    
    .save-all-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .save-spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top: 2px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .success-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.5s ease;
    }
    
    .success-toast.show {
        opacity: 1;
        transform: translateX(0);
    }
</style>
{% endblock %}

{% block content %}
<div class="matrix-container">
    <div class="matrix-header">
        <div class="matrix-title">
            <div style="font-size: 2rem;">
                {% if is_real_data %}üî¥{% endif %}
            </div>
            <div>
                <h3 style="margin: 0;">MATRIZ DE DATOS CONFIDENCIALES</h3>
                {% if is_real_data %}
                <div class="data-type-badge">
                    üîí INFORMACI√ìN ULTRA-SECRETA
                </div>
                {% endif %}
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; align-items: center;">
            <a href="{% url 'secure_data:logout_secure' %}" class="logout-btn" onclick="return confirmExit()">
                <span>üö™</span>
                <span>Salir Seguro</span>
            </a>
        </div>
    </div>
    
    <div class="matrix-table-container">
        <table class="matrix-table">
            <thead>
                <tr>
                    <th class="row-header">#</th>
                    {% for col in "0123456789"|make_list %}
                        <th>COL {{ col }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in "01234567890123456789"|make_list %}
                    <tr>
                        <td class="row-header">{{ forloop.counter0 }}</td>
                        {% for col in "0123456789"|make_list %}
                            <td>
                                <textarea 
                                    class="cell-input {% if matrix_data|get_item:forloop.parentloop.counter0|get_item:forloop.counter0 %}has-content{% endif %}"
                                    data-row="{{ forloop.parentloop.counter0 }}"
                                    data-col="{{ forloop.counter0 }}"
                                    placeholder="..."
                                >{{ matrix_data|get_item:forloop.parentloop.counter0|get_item:forloop.counter0 }}</textarea>
                                <div class="save-indicator"></div>
                            </td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div class="status-bar">
        <div>
            <span class="encryption-badge">üîê AES-256</span>
            Usuario: {{ user.email }} | Sesi√≥n Segura Activa
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <button id="emergency-exit-btn" class="emergency-exit-btn" onclick="emergencyExit()" title="Salida de emergencia (Esc)">
                <span>{% if is_real_data %}üö®{% else %}‚ö†Ô∏è{% endif %}</span>
                <span>{% if is_real_data %}SALIR AHORA{% else %}Salir R√°pido{% endif %}</span>
            </button>
            <button id="save-all-btn" class="save-all-btn" onclick="saveAllData()" title="Guardar toda la matriz (Ctrl+S)">
                <span id="save-btn-icon">üíæ</span>
                <span id="save-btn-text">Guardar Todo</span>
                <small style="opacity: 0.8;">(Ctrl+S)</small>
            </button>
            <div>
                √öltima actualizaci√≥n: <span id="last-update">--</span>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const cellInputs = document.querySelectorAll('.cell-input');
    
    cellInputs.forEach(input => {
        let saveTimeout;
        
        input.addEventListener('input', function() {
            const indicator = this.parentElement.querySelector('.save-indicator');
            const row = this.dataset.row;
            const col = this.dataset.col;
            const value = this.value;
            
            // Clear existing timeout
            clearTimeout(saveTimeout);
            
            // Show saving indicator
            indicator.className = 'save-indicator saving';
            
            // Update content class
            if (value.trim()) {
                this.classList.add('has-content');
            } else {
                this.classList.remove('has-content');
            }
            
            // Save after 1 second of no typing
            saveTimeout = setTimeout(() => {
                saveCell(row, col, value, indicator);
            }, 1000);
        });
        
        // Save immediately on blur
        input.addEventListener('blur', function() {
            if (saveTimeout) {
                clearTimeout(saveTimeout);
                const indicator = this.parentElement.querySelector('.save-indicator');
                const row = this.dataset.row;
                const col = this.dataset.col;
                const value = this.value;
                saveCell(row, col, value, indicator);
            }
        });
    });
    
    function saveCell(row, col, value, indicator) {
        fetch('{% url "secure_data:update_cell" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                row: parseInt(row),
                col: parseInt(col),
                value: value
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                indicator.className = 'save-indicator saved';
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
                setTimeout(() => {
                    indicator.className = 'save-indicator';
                }, 2000);
            } else {
                indicator.className = 'save-indicator error';
                console.error('Error saving cell:', data.error);
            }
        })
        .catch(error => {
            indicator.className = 'save-indicator error';
            console.error('Network error:', error);
        });
    }
    
    // Add CSRF token to all requests
    const csrfToken = '{{ csrf_token }}';
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken;
    document.body.appendChild(csrfInput);
});

// Funci√≥n para guardar todos los datos de la matriz
function saveAllData() {
    const saveBtn = document.getElementById('save-all-btn');
    const saveIcon = document.getElementById('save-btn-icon');
    const saveText = document.getElementById('save-btn-text');
    
    // Deshabilitar bot√≥n y mostrar spinner
    saveBtn.disabled = true;
    saveIcon.innerHTML = '<div class="save-spinner"></div>';
    saveText.textContent = 'Guardando...';
    
    // Recopilar todos los datos de la matriz
    const matrixData = {};
    const cellInputs = document.querySelectorAll('.cell-input');
    
    cellInputs.forEach(input => {
        const row = parseInt(input.dataset.row);
        const col = parseInt(input.dataset.col);
        const value = input.value.trim();
        
        if (!matrixData[row]) {
            matrixData[row] = {};
        }
        matrixData[row][col] = value;
    });
    
    // Enviar todos los datos al servidor
    fetch('{% url "secure_data:save_matrix" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            matrix_data: matrixData
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // √âxito
            saveIcon.innerHTML = '‚úÖ';
            saveText.textContent = 'Guardado';
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
            
            // Mostrar toast de √©xito
            showSuccessToast(`Matriz guardada exitosamente: ${data.cells_updated || 0} celdas actualizadas`);
            
            // Mostrar todas las celdas como guardadas
            document.querySelectorAll('.save-indicator').forEach(indicator => {
                indicator.className = 'save-indicator saved';
                setTimeout(() => {
                    indicator.className = 'save-indicator';
                }, 2000);
            });
            
            // Restaurar bot√≥n despu√©s de 2 segundos
            setTimeout(() => {
                saveBtn.disabled = false;
                saveIcon.innerHTML = 'üíæ';
                saveText.textContent = 'Guardar Todo';
            }, 2000);
        } else {
            // Error
            saveIcon.innerHTML = '‚ùå';
            saveText.textContent = 'Error';
            console.error('Error saving matrix:', data.error);
            
            // Restaurar bot√≥n despu√©s de 3 segundos
            setTimeout(() => {
                saveBtn.disabled = false;
                saveIcon.innerHTML = 'üíæ';
                saveText.textContent = 'Guardar Todo';
            }, 3000);
        }
    })
    .catch(error => {
        // Error de red
        saveIcon.innerHTML = '‚ùå';
        saveText.textContent = 'Error de Red';
        console.error('Network error:', error);
        
        // Restaurar bot√≥n despu√©s de 3 segundos
        setTimeout(() => {
            saveBtn.disabled = false;
            saveIcon.innerHTML = 'üíæ';
            saveText.textContent = 'Guardar Todo';
        }, 3000);
    });
}

// Funci√≥n para salida de emergencia
function emergencyExit() {
    // Mostrar confirmaci√≥n
    if (confirm('‚ö†Ô∏è SALIDA DE EMERGENCIA\n\n¬øEst√° seguro de que desea salir inmediatamente?\n\nSe perder√°n los cambios no guardados.')) {
        
        // Limpiar sesi√≥n inmediatamente
        const emergencyBtn = document.getElementById('emergency-exit-btn');
        emergencyBtn.innerHTML = '<span>üîÑ</span><span>Saliendo...</span>';
        emergencyBtn.disabled = true;
        
        // Enviar beacon para logout inmediato (no espera respuesta)
        if (navigator.sendBeacon) {
            navigator.sendBeacon('{% url "secure_data:logout_beacon" %}', 
                new FormData().append('csrfmiddlewaretoken', '{{ csrf_token }}'));
        }
        
        // Limpiar datos locales
        sessionStorage.clear();
        localStorage.clear();
        
        // Redirigir inmediatamente
        window.location.href = '{% url "secure_data:logout_secure" %}';
        
        // Backup: forzar recarga despu√©s de 2 segundos
        setTimeout(() => {
            window.location.reload();
        }, 2000);
    }
}

// Funci√≥n para mostrar toast de √©xito
function showSuccessToast(message) {
    // Crear o reutilizar el toast
    let toast = document.getElementById('success-toast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'success-toast';
        toast.className = 'success-toast';
        document.body.appendChild(toast);
    }
    
    toast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 18px;">‚úÖ</span>
            <span>${message}</span>
        </div>
    `;
    
    // Mostrar toast
    toast.classList.add('show');
    
    // Ocultar despu√©s de 4 segundos
    setTimeout(() => {
        toast.classList.remove('show');
    }, 4000);
}

// Funci√≥n para confirmar salida normal
function confirmExit() {
    return confirm('¬øEst√° seguro de que desea salir del modo seguro?\n\nAseg√∫rese de haber guardado todos los cambios importantes.');
}

// Custom template filter simulation for getting nested dict values
document.addEventListener('DOMContentLoaded', function() {
    // Matrix data is already rendered server-side, no additional processing needed
    
    // Agregar atajo de teclado Ctrl+S para guardar
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault(); // Prevenir el guardado del navegador
            saveAllData();
        }
        
        // Atajo Esc para salida de emergencia
        if (e.key === 'Escape') {
            e.preventDefault();
            emergencyExit();
        }
    });
    
    // Actualizar el tooltip del bot√≥n para mostrar el atajo
    const saveBtn = document.getElementById('save-all-btn');
    if (saveBtn) {
        saveBtn.title = 'Guardar toda la matriz (Ctrl+S)';
    }
});
</script>
{% endblock %}
