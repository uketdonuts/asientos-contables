{% extends "secure_data/base_secure.html" %}
{% load static %}

{% block title %}Login Ultra-Seguro - Sistema Confidencial{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 bg-gradient-to-br from-gray-50 to-gray-100">
    <div class="max-w-md w-full space-y-8">
        <!-- Login Card -->
        <div class="bg-white rounded-xl shadow-2xl border border-gray-200 overflow-hidden">
            <!-- Header del Login -->
            <div class="bg-gradient-to-r from-red-800 to-red-700 px-8 py-6 text-center">
                <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-shield-alt text-white text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">ACCESO ULTRA-SEGURO</h2>
                <p class="text-red-100 text-sm">Autenticación de Múltiples Factores</p>
                <div class="mt-4 flex justify-center space-x-2">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-900 text-white">
                        <i class="fas fa-user-check mr-1"></i>{{ user.username }}
                    </span>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-700 text-white">
                        <i class="fas fa-lock mr-1"></i>2FA
                    </span>
                </div>
            </div>

            <!-- Formulario de Login -->
            <div class="px-8 py-6">
                {% if messages %}
                    {% for message in messages %}
                        <div class="mb-6 rounded-lg p-4 border-l-4 {% if message.tags == 'success' %}border-green-600 bg-green-50{% elif message.tags == 'error' %}border-red-600 bg-red-50{% elif message.tags == 'warning' %}border-yellow-600 bg-yellow-50{% else %}border-blue-600 bg-blue-50{% endif %}">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    {% if message.tags == 'success' %}
                                        <i class="fas fa-check-circle text-green-600"></i>
                                    {% elif message.tags == 'error' %}
                                        <i class="fas fa-exclamation-circle text-red-600"></i>
                                    {% elif message.tags == 'warning' %}
                                        <i class="fas fa-exclamation-triangle text-yellow-600"></i>
                                    {% else %}
                                        <i class="fas fa-info-circle text-blue-600"></i>
                                    {% endif %}
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium {% if message.tags == 'success' %}text-green-800{% elif message.tags == 'error' %}text-red-800{% elif message.tags == 'warning' %}text-yellow-800{% else %}text-blue-800{% endif %}">{{ message }}</p>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}

                <form method="post" novalidate id="secureAccessForm" class="space-y-6">
                    {% csrf_token %}
                    
                    <!-- Contraseña de Acceso -->
                    <div>
                        <label for="{{ form.password.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-key text-red-700 mr-2"></i>
                            Contraseña de Acceso Seguro
                        </label>
                        <div class="relative">
                            {{ form.password }}
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                <i class="fas fa-lock text-gray-400"></i>
                            </div>
                        </div>
                        {% if form.password.errors %}
                            <div class="mt-2 text-sm text-red-600">
                                {{ form.password.errors }}
                            </div>
                        {% endif %}
                        <p class="mt-1 text-xs text-gray-500">
                            Contraseña especial para acceso al módulo confidencial
                        </p>
                    </div>
                    
                    <!-- Código 2FA Email -->
                    <div>
                        <label for="{{ form.verification_code.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-envelope text-blue-700 mr-2"></i>
                            Código 2FA (Email)
                        </label>
                        <div class="relative">
                            {{ form.verification_code }}
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                <i class="fas fa-envelope text-gray-400"></i>
                            </div>
                        </div>
                        {% if form.verification_code.errors %}
                            <div class="mt-2 text-sm text-red-600">
                                {{ form.verification_code.errors }}
                            </div>
                        {% endif %}
                        <p class="mt-1 text-xs text-gray-500">
                            Código enviado a: <span class="font-medium">{{ user.email }}</span>
                        </p>
                    </div>
                    
                    <!-- Código 2FA Authenticator -->
                    <div>
                        <label for="{{ form.app_verification_code.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-mobile-alt text-green-700 mr-2"></i>
                            Código 2FA (Authenticator)
                        </label>
                        <div class="relative">
                            {{ form.app_verification_code }}
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                <i class="fas fa-mobile-alt text-gray-400"></i>
                            </div>
                        </div>
                        {% if form.app_verification_code.errors %}
                            <div class="mt-2 text-sm text-red-600">
                                {{ form.app_verification_code.errors }}
                            </div>
                        {% endif %}
                        <p class="mt-1 text-xs text-gray-500">
                            Código de tu aplicación autenticadora (Google Authenticator, Authy, etc.)
                        </p>
                    </div>
                    
                    {% if form.non_field_errors %}
                        <div class="rounded-lg p-4 border-l-4 border-red-600 bg-red-50">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exclamation-circle text-red-600"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-red-800">{{ form.non_field_errors }}</p>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Botón de Login -->
                    <div class="pt-4">
                        <button type="submit" class="w-full btn-secure" id="submitButton">
                            <i class="fas fa-rocket mr-2"></i>
                            ACCEDER AL SISTEMA
                        </button>
                    </div>
                </form>
            </div>

            <!-- Footer del Login -->
            <div class="bg-gray-50 px-8 py-4 border-t border-gray-200">
                <div class="text-center">
                    <div class="flex items-center justify-center space-x-4 text-xs text-gray-600 mb-3">
                        <span class="flex items-center">
                            <i class="fas fa-shield-alt text-green-700 mr-1"></i>
                            AES-256
                        </span>
                        <span class="flex items-center">
                            <i class="fas fa-eye text-blue-700 mr-1"></i>
                            Monitoreado
                        </span>
                        <span class="flex items-center">
                            <i class="fas fa-clock text-yellow-700 mr-1"></i>
                            Tiempo Real
                        </span>
                    </div>
                    <p class="text-xs text-gray-500">
                        <i class="fas fa-exclamation-triangle text-red-600 mr-1"></i>
                        Acceso restringido solo a personal autorizado
                    </p>
                </div>
            </div>
        </div>

        <!-- Información Adicional -->
        <div class="text-center space-y-4">
            <!-- Aviso de Seguridad -->
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-red-600 mt-0.5"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800">Aviso de Seguridad</h3>
                        <div class="mt-2 text-xs text-red-700 space-y-1">
                            <p>• Este sistema utiliza encriptación AES-256</p>
                            <p>• Todos los accesos son registrados y monitoreados</p>
                            <p>• Solo personal autorizado puede acceder</p>
                            <p>• El acceso no autorizado es un delito</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enlaces de Ayuda -->
            <div class="text-xs text-gray-500 space-y-1">
                <p>¿Problemas con la autenticación? Contacta al administrador del sistema</p>
                <p>Este acceso está protegido por múltiples capas de seguridad</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // VALIDACIÓN: Solo ejecutar este script en el módulo ultra-seguro
    if (!window.location.pathname.includes('/secure/xk9mz8p4q7w3n6v2/')) {
        console.log('Script del módulo seguro NO ejecutado - URL incorrecta');
        return;
    }
    
    console.log('Script del módulo ultra-seguro ejecutándose...');
    
    // Auto-focus en el primer campo
    const passwordField = document.getElementById('{{ form.password.id_for_label }}');
    if (passwordField) {
        passwordField.focus();
    }
    
    // Validación en tiempo real
    const form = document.getElementById('secureAccessForm');
    const submitButton = document.getElementById('submitButton');
    
    if (form && submitButton) {
        form.addEventListener('submit', function(e) {
            // Deshabilitar botón para evitar doble envío
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Verificando...';
            
            // Re-habilitar después de 5 segundos por si hay error
            setTimeout(function() {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-rocket mr-2"></i>ACCEDER AL SISTEMA';
            }, 5000);
        });
    }
    
    // Validación de campos en tiempo real
    const inputs = form.querySelectorAll('input[type="text"], input[type="password"]');
    inputs.forEach(function(input) {
        input.addEventListener('input', function() {
            if (this.value.trim() !== '') {
                this.classList.remove('border-red-300');
                this.classList.add('border-green-300');
                this.parentElement.classList.add('has-success');
            } else {
                this.classList.remove('border-green-300');
                this.classList.add('border-gray-300');
                this.parentElement.classList.remove('has-success');
            }
        });
        
        // Efecto de focus
        input.addEventListener('focus', function() {
            this.parentElement.classList.add('focused');
        });
        
        input.addEventListener('blur', function() {
            this.parentElement.classList.remove('focused');
        });
    });
    
    // Animación de entrada
    const loginCard = document.querySelector('.bg-white');
    if (loginCard) {
        loginCard.style.opacity = '0';
        loginCard.style.transform = 'translateY(20px)';
        
        setTimeout(function() {
            loginCard.style.transition = 'all 0.5s ease-out';
            loginCard.style.opacity = '1';
            loginCard.style.transform = 'translateY(0)';
        }, 100);
    }
});
</script>

<style>
/* Estilos específicos para el login con paleta suavizada */
.bg-white {
    backdrop-filter: blur(10px);
    background: rgba(255, 255, 255, 0.95);
}

.btn-secure {
    background: linear-gradient(135deg, #b91c1c 0%, #7f1d1d 100%);
    color: white;
    border: none;
    padding: 14px 28px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.08);
}

.btn-secure:hover {
    background: linear-gradient(135deg, #7f1d1d 0%, #b91c1c 100%);
    color: white;
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
}

.btn-secure:active {
    background: #7f1d1d;
}

.btn-secure:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* Efectos de focus para los campos */
.relative.focused input {
    border-color: #b91c1c;
    box-shadow: 0 0 0 3px rgba(185, 28, 28, 0.1);
}

.relative.has-success input {
    border-color: #15803d;
    background-color: #e7f6ed;
}

/* Animación de pulse para elementos importantes */
@keyframes securePulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.fa-shield-alt {
    animation: securePulse 2s infinite;
}
</style>
{% endblock %}
