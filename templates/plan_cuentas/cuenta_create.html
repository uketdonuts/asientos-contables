{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - Sistema Contable{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header Section -->
    <div class="bg-white shadow-sm rounded-lg mb-6">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-medium text-gray-900">
                <i class="fas fa-{% if button_text == 'Crear Cuenta' %}plus{% else %}edit{% endif %} mr-2"></i>
                {{ title }}
            </h3>
            <a href="{% url 'plan_cuentas:cuenta_list' %}" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                <i class="fas fa-arrow-left mr-1"></i> Volver
            </a>
        </div>
    </div>

    <!-- Main Form Section -->
    <div class="bg-white shadow-sm rounded-lg">
        <!-- Información del Sistema - Solo para edición -->
        {% if form.instance.pk %}
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <h4 class="text-sm font-medium text-gray-700 mb-3">
                <i class="fas fa-info-circle text-blue-600 mr-2"></i>Información del Sistema
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="flex items-center">
                    <span class="text-sm text-gray-500 mr-3">ID:</span>
                    <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">
                        {{ form.instance.id }}
                    </span>
                </div>
            </div>
        </div>
        {% endif %}

        <form method="post" class="p-6">
            {% csrf_token %}
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Código de Cuenta Field -->
                <div>
                    <label for="{{ form.cuenta.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-code text-indigo-600 mr-2"></i>
                        Código de Cuenta <span class="text-red-500">*</span>
                    </label>
                    {{ form.cuenta }}
                    {% if form.cuenta.help_text %}
                        <p class="mt-1 text-sm text-gray-500">{{ form.cuenta.help_text }}</p>
                    {% endif %}
                    {% if form.cuenta.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            <i class="fas fa-exclamation-circle mr-1"></i>
                            {{ form.cuenta.errors.0 }}
                        </div>
                    {% endif %}
                </div>

                <!-- Plan de Cuentas Field -->
                <div>
                    <label for="{{ form.plan_cuentas.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-folder-open text-blue-600 mr-2"></i>
                        Plan de Cuentas <span class="text-red-500">*</span>
                    </label>
                    {{ form.plan_cuentas }}
                    {% if form.plan_cuentas.help_text %}
                        <p class="mt-1 text-sm text-gray-500">{{ form.plan_cuentas.help_text }}</p>
                    {% endif %}
                    {% if form.plan_cuentas.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            <i class="fas fa-exclamation-circle mr-1"></i>
                            {{ form.plan_cuentas.errors.0 }}
                        </div>
                    {% endif %}
                </div>

                <!-- Descripción Field -->
                <div class="md:col-span-2">
                    <label for="{{ form.descripcion.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-file-alt text-purple-600 mr-2"></i>
                        Descripción <span class="text-red-500">*</span>
                    </label>
                    {{ form.descripcion }}
                    {% if form.descripcion.help_text %}
                        <p class="mt-1 text-sm text-gray-500">{{ form.descripcion.help_text }}</p>
                    {% endif %}
                    {% if form.descripcion.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            <i class="fas fa-exclamation-circle mr-1"></i>
                            {{ form.descripcion.errors.0 }}
                        </div>
                    {% endif %}
                </div>

                <!-- Cuenta Madre Field -->
                <div>
                    <label for="{{ form.cuenta_madre.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-sitemap text-teal-600 mr-2"></i>
                        Cuenta Madre
                    </label>
                    {{ form.cuenta_madre }}
                    {% if form.cuenta_madre.help_text %}
                        <p class="mt-1 text-sm text-gray-500">{{ form.cuenta_madre.help_text }}</p>
                    {% endif %}
                    {% if form.cuenta_madre.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            <i class="fas fa-exclamation-circle mr-1"></i>
                            {{ form.cuenta_madre.errors.0 }}
                        </div>
                    {% endif %}
                </div>

                <!-- Grupo Field -->
                <div>
                    <label for="{{ form.grupo.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-layer-group text-orange-600 mr-2"></i>
                        Grupo Contable
                    </label>
                    {{ form.grupo }}
                    {% if form.grupo.help_text %}
                        <p class="mt-1 text-sm text-gray-500">{{ form.grupo.help_text }}</p>
                    {% endif %}
                    {% if form.grupo.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            <i class="fas fa-exclamation-circle mr-1"></i>
                            {{ form.grupo.errors.0 }}
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Botones de acción -->
            <div class="mt-6 flex justify-end space-x-3">
                <a href="{% url 'plan_cuentas:cuenta_list' %}" class="bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-2 px-4 rounded-md transition-colors">
                    Cancelar
                </a>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors">
                    <i class="fas fa-save mr-2"></i>
                    {{ button_text }}
                </button>
            </div>
        </form>

        <!-- Sección de ayuda para nuevas cuentas -->
        {% if not form.instance.pk %}
        <div class="px-6 py-4 border-t border-gray-200 bg-blue-50">
            <h4 class="text-sm font-medium text-blue-800 mb-2">
                <i class="fas fa-lightbulb text-blue-600 mr-2"></i>Información sobre cuentas contables
            </h4>
            <ul class="text-sm text-blue-700 space-y-1">
                <li><i class="fas fa-check text-blue-600 mr-2"></i>El ID se generará automáticamente</li>
                <li><i class="fas fa-check text-blue-600 mr-2"></i>El código de cuenta debe ser único dentro del plan</li>
                <li><i class="fas fa-check text-blue-600 mr-2"></i>La cuenta madre es opcional para cuentas principales</li>
                <li><i class="fas fa-check text-blue-600 mr-2"></i>Los grupos: 1=Activos, 2=Pasivos, 3=Patrimonio, 4=Ingresos, 5=Gastos</li>
            </ul>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const planCuentasSelect = document.getElementById('id_plan_cuentas');
    const cuentaMadreSelect = document.getElementById('id_cuenta_madre');
    
    if (planCuentasSelect && cuentaMadreSelect) {
        // Función para filtrar cuentas madre por plan de cuentas
        function updateCuentaMadreOptions(planId) {
            const cuentaActualId = document.querySelector('input[name="cuenta_id"]')?.value;
            
            if (!cuentaMadreSelect) return;
            
            // Limpiar opciones existentes
            cuentaMadreSelect.innerHTML = '<option value="">Seleccione una cuenta madre (opcional)</option>';
            
            if (!planId) return;
            
            // Mostrar loading
            cuentaMadreSelect.innerHTML = '<option value="">Cargando...</option>';
            cuentaMadreSelect.disabled = true;
            
            // Construir URL con parámetros
            let url = `{% url 'plan_cuentas:get_cuentas_madre_ajax' %}?plan_id=${planId}`;
            if (cuentaActualId) {
                url += `&cuenta_id=${cuentaActualId}`;
            }
            
            // Hacer petición AJAX
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    // Restaurar estado
                    cuentaMadreSelect.disabled = false;
                    cuentaMadreSelect.innerHTML = '<option value="">Seleccione una cuenta madre (opcional)</option>';
                    
                    if (data.cuentas) {
                        data.cuentas.forEach(cuenta => {
                            const option = document.createElement('option');
                            option.value = cuenta.id;
                            option.textContent = `${cuenta.cuenta} - ${cuenta.descripcion}`;
                            cuentaMadreSelect.appendChild(option);
                        });
                    } else if (data.error) {
                        console.error('Error cargando cuentas madre:', data.error);
                        showNotification('Error al cargar las cuentas madre', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error en la petición AJAX:', error);
                    cuentaMadreSelect.disabled = false;
                    cuentaMadreSelect.innerHTML = '<option value="">Error al cargar opciones</option>';
                    showNotification('Error de conexión al cargar las cuentas madre', 'error');
                });
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 max-w-sm transition-all duration-300 ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'warning' ? 'bg-yellow-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            
            notification.innerHTML = `
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i class="fas ${
                            type === 'success' ? 'fa-check-circle' :
                            type === 'error' ? 'fa-exclamation-circle' :
                            type === 'warning' ? 'fa-exclamation-triangle' :
                            'fa-info-circle'
                        }"></i>
                    </div>
                    <div class="ml-3 text-sm font-medium">
                        ${message}
                    </div>
                    <div class="ml-auto pl-3">
                        <button class="text-white hover:text-gray-200 focus:outline-none" onclick="this.parentElement.parentElement.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
        
        // Evento cuando cambia el plan de cuentas
        planCuentasSelect.addEventListener('change', function() {
            updateCuentaMadreOptions(this.value);
        });
        
        // Si hay un plan ya seleccionado al cargar la página (para edición)
        if (planCuentasSelect.value) {
            updateCuentaMadreOptions(planCuentasSelect.value);
        }
    }
});
</script>
{% endblock %} 